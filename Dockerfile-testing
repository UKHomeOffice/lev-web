FROM lev-web

USER root
ENV NODE_ENV ci
RUN apk add --no-cache \
      bzip2 \
      fontconfig \
      git \
      g++ \
      make \
      python \
 && npm install > .npm-install.log 2>&1 \
 && rm .npm-install.log \
 || ( EC=$?; cat .npm-install.log; exit $EC ) \
 && apk del --no-cache \
      g++ \
      make \
      python \
 && chown -R app:app .

USER 31337
CMD [ "npm", "run", "test:ci" ]
